<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CP Bank</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="index.css">

</head>

<body>
    <!-- Real-time connection indicator -->
    <div id="realtimeIndicator" class="realtime-indicator">
        üü¢ Connected
    </div>

    <!-- Authentication Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-header">
            <h1 id="authTitle">üéØ Welcome to Problem Bank</h1>
            <p>Join the collaborative competitive programming community</p>
        </div>
        <div class="auth-form">
            <div class="error-message" id="authError"></div>
            <div class="loading" id="authLoading">
                <p>‚è≥ Processing...</p>
            </div>

            <form id="authForm">
                <div class="form-group">
                    <label for="authUsername">Username</label>
                    <input type="text" id="authUsername" required placeholder="Enter username">
                </div>
                <div class="form-group" id="emailGroup">
                    <label for="authEmail">Email</label>
                    <input type="email" id="authEmail" required placeholder="Enter email">
                </div>
                <div class="form-group">
                    <label for="authPassword">Password</label>
                    <input type="password" id="authPassword" required placeholder="Enter password">
                </div>
                <button type="submit" class="btn" style="width: 100%;" id="authSubmitBtn">Login</button>
            </form>

            <div class="auth-toggle">
                <span id="authToggleText">Don't have an account?</span>
                <a id="authToggleLink">Sign up here</a>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="container" style="display: none;">
        <div class="header">
            <h1>üéØ Competitive Programming Bank</h1>
            <p>Share and discover competitive programming problems with the community</p>
            <div class="user-info">
                <div class="username" id="currentUser"></div>
                <button class="logout-btn" onclick="logout()">
                    <div class="sign"><svg viewBox="0 0 512 512">
                            <path
                                d="M377.9 105.9L500.7 228.7c7.2 7.2 11.3 17.1 11.3 27.3s-4.1 20.1-11.3 27.3L377.9 406.1c-6.4 6.4-15 9.9-24 9.9c-18.7 0-33.9-15.2-33.9-33.9l0-62.1-128 0c-17.7 0-32-14.3-32-32l0-64c0-17.7 14.3-32 32-32l128 0 0-62.1c0-18.7 15.2-33.9 33.9-33.9c9 0 17.6 3.6 24 9.9zM160 96L96 96c-17.7 0-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-64 0c-53 0-96-43-96-96L0 128C0 75 43 32 96 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32z">
                            </path>
                        </svg></div>

                    <div class="text">Logout</div>
                </button>
            </div>
        </div>

        <nav class="nav-tabs">
            <!-- From Uiverse.io by Voxybuns -->
            <button class="active" onclick="showTab('community')">
                <span class="button_top">üåç Community</span>
            </button>

            <button onclick="showTab('my-problems')">
                <span class="button_top">üìù My Problems</span>
            </button>

            <button onclick="showTab('add')">
                <span class="button_top">‚ûï Add Problem</span>
            </button>

            <button onclick="showTab('search')">
                <span class="button_top">üîç Search</span>
            </button>

            <button onclick="showTab('stats')">
                <span class="button_top">üìä Statistics</span>
            </button>

        </nav>

        <!-- Community Tab -->
        <div id="community" class="tab-content active">
            <h2>üë• Community Members</h2>
            <div class="loading" id="communityLoading">
                <p>üì° Loading community data...</p>
            </div>
            <div id="usersGrid" class="users-grid"></div>
        </div>

        <!-- My Problems Tab -->
        <div id="my-problems" class="tab-content">
            <div class="loading" id="myProblemsLoading">
                <p>üì° Loading your problems...</p>
            </div>
            <div id="myProblemsList"></div>
        </div>

        <!-- Add Problem Tab -->
        <div id="add" class="tab-content">
            <div class="success-message" id="successMessage">
                ‚úÖ Problem added successfully!
            </div>

            <form id="addProblemForm">
                <div class="form-group">
                    <label for="title">Problem Title *</label>
                    <input type="text" id="title" required placeholder="Enter problem title">
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label for="source">Source</label>
                        <input type="text" id="source" placeholder="e.g., Codeforces, LeetCode">
                    </div>
                    <div class="form-group">
                        <label for="difficulty">Difficulty</label>
                        <select id="difficulty">
                            <option value="">Select difficulty</option>
                            <option value="Easy">Easy</option>
                            <option value="Medium">Medium</option>
                            <option value="Hard">Hard</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="topic">Topic</label>
                        <input type="text" id="topic" placeholder="e.g., Arrays, DP, Math">
                    </div>
                </div>

                <div class="form-group">
                    <label for="description">Problem Description</label>
                    <textarea id="description" placeholder="Describe the problem..."></textarea>
                </div>

                <div class="form-group">
                    <label for="solution">Your Solution Approach</label>
                    <textarea id="solution"
                        placeholder="Explain your approach, algorithm, time complexity..."></textarea>
                </div>

                <div class="form-group">
                    <label for="notes">Additional Notes (Optional)</label>
                    <textarea id="notes" rows="3"
                        placeholder="Any additional thoughts, tricks, or reminders..."></textarea>
                </div>

                <button type="submit" class="btn" id="addProblemBtn">üíæ Save Problem</button>
            </form>
        </div>

        <!-- Search Tab -->
        <div id="search" class="tab-content">
            <div class="user-selector">
                <label>Search in:</label>
                <select id="searchUserFilter">
                    <option value="all">All Users</option>
                    <option value="mine">My Problems Only</option>
                </select>
            </div>

            <div class="search-box">
                <input type="text" id="searchQuery" placeholder="Search problems...">
                <select id="searchFilter">
                    <option value="all">All Fields</option>
                    <option value="title">Title</option>
                    <option value="topic">Topic</option>
                    <option value="difficulty">Difficulty</option>
                    <option value="source">Source</option>
                </select>
                <button class="btn" onclick="searchProblems()">üîç Search</button>
            </div>
            <div class="loading" id="searchLoading">
                <p>üîç Searching...</p>
            </div>
            <div id="searchResults"></div>
        </div>

        <!-- Statistics Tab -->
        <div id="stats" class="tab-content">
            <div class="user-selector">
                <label>View statistics for:</label>
                <select id="statsUserFilter" onchange="displayStatistics()">
                    <option value="all">All Users Combined</option>
                    <option value="mine">My Statistics</option>
                </select>
            </div>
            <div class="loading" id="statsLoading">
                <p>üìä Loading statistics...</p>
            </div>
            <div class="stats-grid" id="statsGrid"></div>
            <div id="detailedStats"></div>
        </div>

        <!-- User Profile View -->
        <div id="user-profile" class="tab-content">
            <button class="btn btn-secondary back-btn" onclick="showTab('community')">‚Üê Back to Community</button>
            <div class="loading" id="profileLoading">
                <p>üë§ Loading profile...</p>
            </div>
            <div id="profileHeader"></div>
            <div id="profileProblems"></div>
        </div>
    </div>

    <!-- Problem Details Modal -->
    <div id="problemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Problem Details</h2>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        // REPLACE THESE WITH YOUR ACTUAL SUPABASE PROJECT CREDENTIALS
        const SUPABASE_URL = 'https://gbjcgnyimvhetfgbofmq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdiamNnbnlpbXZoZXRmZ2JvZm1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMzgzMzQsImV4cCI6MjA3MDgxNDMzNH0.W4eJfUbJtIRs16IXPFoqE9SuePGTudpGEkmxgngsVQQ';

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global state
        let currentUser = null;
        let currentSession = null;
        let isLogin = true;
        let problemsSubscription = null;
        let usersCache = new Map();

        // Initialize app
        document.addEventListener('DOMContentLoaded', function () {
            setupAuthForm();
            checkAuthState();
            setupRealtimeSubscriptions();
        });

        // Authentication state management
        function checkAuthState() {
            supabase.auth.onAuthStateChange((event, session) => {
                currentSession = session;

                if (event === 'SIGNED_IN' && session) {
                    currentUser = session.user.user_metadata.username || session.user.email;
                    updateRealtimeIndicator('connected');
                    showMainApp();
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    updateRealtimeIndicator('disconnected');
                    cleanupSubscriptions();
                    showAuthScreen();
                }
            });
        }

        function updateRealtimeIndicator(status) {
            const indicator = document.getElementById('realtimeIndicator');
            indicator.className = `realtime-indicator ${status}`;
            indicator.textContent = status === 'connected' ? 'üü¢ Connected' : 'üî¥ Offline';
        }

        function showAuthScreen() {
            document.getElementById('authScreen').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
        }

        function showMainApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('currentUser').textContent = currentUser;

            // Load initial data
            displayCommunity();
            displayMyProblems();
            populateUserFilters();
        }

        function setupAuthForm() {
            document.getElementById('authToggleLink').addEventListener('click', toggleAuthMode);
            document.getElementById('authForm').addEventListener('submit', handleAuth);
        }

        function toggleAuthMode() {
            isLogin = !isLogin;
            const title = document.getElementById('authTitle');
            const submitBtn = document.getElementById('authSubmitBtn');
            const toggleText = document.getElementById('authToggleText');
            const toggleLink = document.getElementById('authToggleLink');

            if (isLogin) {
                title.innerHTML = 'üéØ Welcome Back';
                submitBtn.textContent = 'Login';
                toggleText.textContent = "Don't have an account?";
                toggleLink.textContent = 'Sign up here';
            } else {
                title.innerHTML = 'üéØ Join Problem Bank';
                submitBtn.textContent = 'Sign Up';
                toggleText.textContent = 'Already have an account?';
                toggleLink.textContent = 'Login here';
            }

            // Clear form
            document.getElementById('authForm').reset();
            hideError();
        }

        async function handleAuth(e) {
            e.preventDefault();
            const username = document.getElementById('authUsername').value.trim();
            const password = document.getElementById('authPassword').value;
            const email = document.getElementById('authEmail').value.trim();

            if (!username || !password || (!isLogin && !email)) {
                showError('Please fill in all required fields.');
                return;
            }

            showLoading('authLoading');
            hideError();

            try {
                if (isLogin) {
                    // Login
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password,
                    });

                    if (error) throw error;
                } else {
                    // Sign up
                    const { data, error } = await supabase.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: {
                                username: username
                            }
                        }
                    });

                    if (error) throw error;

                    // Create user profile in database
                    // const { error: profileError } = await supabase
                    //     .from('users')
                    //     .insert([
                    //         { 
                    //             id: data.user.id,
                    //             username: username,
                    //             email: email
                    //         }
                    //     ]);

                    // if (profileError && !profileError.message.includes('duplicate')) {
                    //     throw profileError;
                    // }

                    if (data.user && !data.session) {
                        showError('Please check your email to confirm your account before logging in.');
                        return;
                    }
                }
            } catch (error) {
                console.error('Auth error:', error);
                showError(error.message);
            } finally {
                hideLoading('authLoading');
            }
        }

        async function logout() {
            try {
                await supabase.auth.signOut();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('authError').style.display = 'none';
        }

        function showLoading(elementId) {
            document.getElementById(elementId).style.display = 'block';
        }

        function hideLoading(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }

        // Real-time subscriptions
        function setupRealtimeSubscriptions() {
            // Subscribe to problems changes
            problemsSubscription = supabase
                .channel('problems_changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'problems' },
                    (payload) => {
                        console.log('Problems change:', payload);
                        refreshCurrentView();
                    }
                )
                .subscribe();
        }

        function cleanupSubscriptions() {
            if (problemsSubscription) {
                supabase.removeChannel(problemsSubscription);
                problemsSubscription = null;
            }
        }

        function refreshCurrentView() {
            const activeTab = document.querySelector('.tab-content.active');
            if (!activeTab) return;

            const tabId = activeTab.id;
            switch (tabId) {
                case 'community':
                    displayCommunity();
                    break;
                case 'my-problems':
                    displayMyProblems();
                    break;
                case 'search':
                    if (document.getElementById('searchQuery').value.trim()) {
                        searchProblems();
                    }
                    break;
                case 'stats':
                    displayStatistics();
                    break;
            }
        }

        // Problem management
        async function addProblem(problemData) {
            try {
                const { data, error } = await supabase
                    .from('problems')
                    .insert([
                        {
                            ...problemData,
                            author: currentUser
                        }
                    ])
                    .select();

                if (error) throw error;
                return data[0];
            } catch (error) {
                console.error('Error adding problem:', error);
                throw error;
            }
        }

        async function getProblems(filters = {}) {
            try {
                let query = supabase
                    .from('problems')
                    .select('*')
                    .order('date_added', { ascending: false });

                if (filters.author) {
                    query = query.eq('author', filters.author);
                }

                if (filters.difficulty) {
                    query = query.eq('difficulty', filters.difficulty);
                }

                if (filters.topic) {
                    query = query.ilike('topic', `%${filters.topic}%`);
                }

                if (filters.search) {
                    query = query.or(`title.ilike.%${filters.search}%,description.ilike.%${filters.search}%,topic.ilike.%${filters.search}%,source.ilike.%${filters.search}%`);
                }

                const { data, error } = await query;

                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Error getting problems:', error);
                return [];
            }
        }

        async function deleteProblem(problemId) {
            try {
                const { error } = await supabase
                    .from('problems')
                    .delete()
                    .eq('id', problemId)
                    .eq('author', currentUser);

                if (error) throw error;
                return true;
            } catch (error) {
                console.error('Error deleting problem:', error);
                throw error;
            }
        }

        async function getUsers() {
            try {
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('join_date', { ascending: false });

                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Error getting users:', error);
                return [];
            }
        }

        async function getUserProblemCount(username) {
            try {
                const { count, error } = await supabase
                    .from('problems')
                    .select('*', { count: 'exact', head: true })
                    .eq('author', username);

                if (error) throw error;
                return count || 0;
            } catch (error) {
                console.error('Error getting user problem count:', error);
                return 0;
            }
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab and activate button
            document.getElementById(tabName).classList.add('active');
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // Find and activate the corresponding button
                const buttons = document.querySelectorAll('.tab-button');
                buttons.forEach(btn => {
                    if (btn.onclick && btn.onclick.toString().includes(tabName)) {
                        btn.classList.add('active');
                    }
                });
            }

            // Load content based on tab
            switch (tabName) {
                case 'community':
                    displayCommunity();
                    break;
                case 'my-problems':
                    displayMyProblems();
                    break;
                case 'stats':
                    displayStatistics();
                    break;
                case 'search':
                    document.getElementById('searchResults').innerHTML = '';
                    populateUserFilters();
                    break;
            }
        }

        // Community functions
        async function displayCommunity() {
            const container = document.getElementById('usersGrid');
            const loadingDiv = document.getElementById('communityLoading');

            showLoading('communityLoading');
            container.innerHTML = '';

            try {
                const users = await getUsers();

                if (users.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No users yet!</h3>
                            <p>Be the first to join the community.</p>
                        </div>
                    `;
                    return;
                }

                // Get problem counts for all users
                const userCardsPromises = users.map(async (user) => {
                    const userProblems = await getProblems({ author: user.username });
                    const difficulties = userProblems.reduce((acc, p) => {
                        acc[p.difficulty || 'Unknown'] = (acc[p.difficulty || 'Unknown'] || 0) + 1;
                        return acc;
                    }, {});

                    const topics = userProblems.reduce((acc, p) => {
                        if (p.topic) acc[p.topic] = true;
                        return acc;
                    }, {});

                    return `
                        <div class="user-card" onclick="viewUserProfile('${user.username}')">
                            <h3>üë§ ${user.username}</h3>
                            <p>Joined: ${new Date(user.join_date).toLocaleDateString()}</p>
                            <div class="stats">
                                <div class="stat">
                                    <div class="stat-number">${userProblems.length}</div>
                                    <div class="stat-label">Problems</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-number">${difficulties.Hard || 0}</div>
                                    <div class="stat-label">Hard</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-number">${Object.keys(topics).length}</div>
                                    <div class="stat-label">Topics</div>
                                </div>
                            </div>
                            <p style="margin-top: 15px; opacity: 0.8;">Click to view profile</p>
                        </div>
                    `;
                });

                const userCards = await Promise.all(userCardsPromises);
                container.innerHTML = userCards.join('');
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Error loading community</h3>
                        <p>Please try again later.</p>
                    </div>
                `;
            } finally {
                hideLoading('communityLoading');
            }
        }

        async function viewUserProfile(username) {
            const headerDiv = document.getElementById('profileHeader');
            const problemsDiv = document.getElementById('profileProblems');
            const loadingDiv = document.getElementById('profileLoading');

            showLoading('profileLoading');
            headerDiv.innerHTML = '';
            problemsDiv.innerHTML = '';

            try {
                // Get user info
                const { data: userData, error: userError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .single();

                if (userError) throw userError;

                // Get user's problems
                const userProblems = await getProblems({ author: username });

                headerDiv.innerHTML = `
                    <div class="user-card" style="margin-bottom: 30px;">
                        <h2>üë§ ${username}'s Profile</h2>
                        <p>Member since: ${new Date(userData.join_date).toLocaleDateString()}</p>
                        <p>Email: ${userData.email || 'Not provided'}</p>
                        <div class="stats">
                            <div class="stat">
                                <div class="stat-number">${userProblems.length}</div>
                                <div class="stat-label">Total Problems</div>
                            </div>
                        </div>
                    </div>
                `;

                problemsDiv.innerHTML = `
                    <h3>üìù ${username}'s Problems</h3>
                    ${userProblems.length === 0 ?
                        '<div class="empty-state"><p>No problems shared yet.</p></div>' :
                        userProblems.map(problem => createProblemCard(problem, false)).join('')
                    }
                `;
            } catch (error) {
                headerDiv.innerHTML = `
                    <div class="empty-state">
                        <h3>Error loading profile</h3>
                        <p>Please try again later.</p>
                    </div>
                `;
            } finally {
                hideLoading('profileLoading');
            }

            showTab('user-profile');
        }

        // Problem form handling
        document.getElementById('addProblemForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const submitBtn = document.getElementById('addProblemBtn');
            const originalText = submitBtn.textContent;

            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Saving...';

            const problem = {
                title: document.getElementById('title').value.trim(),
                source: document.getElementById('source').value.trim(),
                difficulty: document.getElementById('difficulty').value,
                topic: document.getElementById('topic').value.trim(),
                description: document.getElementById('description').value.trim(),
                solution: document.getElementById('solution').value.trim(),
                notes: document.getElementById('notes').value.trim()
            };

            try {
                await addProblem(problem);

                // Show success message
                const successMsg = document.getElementById('successMessage');
                successMsg.style.display = 'block';
                setTimeout(() => {
                    successMsg.style.display = 'none';
                }, 3000);

                // Reset form and refresh displays
                this.reset();
                displayMyProblems();
                displayCommunity();
            } catch (error) {
                alert('Error adding problem: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });

        async function displayMyProblems() {
            const container = document.getElementById('myProblemsList');
            const loadingDiv = document.getElementById('myProblemsLoading');

            showLoading('myProblemsLoading');
            container.innerHTML = '';

            try {
                const myProblems = await getProblems({ author: currentUser });

                if (myProblems.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No problems saved yet!</h3>
                            <p>Click on "Add Problem" to start building your problem bank.</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = myProblems.map(problem => createProblemCard(problem, true)).join('');
            } catch (error) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>Error loading problems</h3>
                        <p>Please try again later.</p>
                    </div>
                `;
            } finally {
                hideLoading('myProblemsLoading');
            }
        }

        // Create problem card HTML
        function createProblemCard(problem, showActions = true) {
            const difficultyClass = problem.difficulty ? `badge-${problem.difficulty.toLowerCase()}` : 'badge-topic';
            const dateAdded = problem.date_added ? new Date(problem.date_added).toLocaleString() : 'Unknown';

            return `
                <div class="problem-card">
                    <div class="problem-header">
                        <div class="problem-title">${problem.title}</div>
                        <div class="problem-author">by ${problem.author}</div>
                        <div class="problem-badges">
                            ${problem.difficulty ? `<span class="badge ${difficultyClass}">${problem.difficulty}</span>` : ''}
                            ${problem.topic ? `<span class="badge badge-topic">${problem.topic}</span>` : ''}
                            ${problem.source ? `<span class="badge badge-source">${problem.source}</span>` : ''}
                        </div>
                    </div>
                    <div class="problem-meta">Added: ${dateAdded}</div>
                    <div class="problem-content">
                        ${problem.description ? `<p>${problem.description.substring(0, 150)}${problem.description.length > 150 ? '...' : ''}</p>` : ''}
                    </div>
                    <div class="problem-actions">
                        <button class="btn" onclick="viewProblem('${problem.id}')">üëÅÔ∏è View Details</button>
                        ${showActions && problem.author === currentUser ? `<button class="btn btn-danger" onclick="confirmDeleteProblem('${problem.id}')">üóëÔ∏è Delete</button>` : ''}
                    </div>
                </div>
            `;
        }

        // View problem details in modal
        function viewProblem(id) {
            const problems = JSON.parse(document.querySelector(`[onclick="viewProblem('${id}')"]`).closest('.problem-card').dataset.problem || '{}');

            // Since we don't store the full problem data in the card, we need to find it from our current data
            // This is a simplified approach - in a real app, you'd fetch by ID from the database
            getProblems().then(allProblems => {
                const problem = allProblems.find(p => p.id === id);
                if (!problem) return;

                document.getElementById('modalTitle').textContent = problem.title;
                document.getElementById('modalContent').innerHTML = `
                    <div class="problem-badges" style="margin-bottom: 20px;">
                        ${problem.difficulty ? `<span class="badge badge-${problem.difficulty.toLowerCase()}">${problem.difficulty}</span>` : ''}
                        ${problem.topic ? `<span class="badge badge-topic">${problem.topic}</span>` : ''}
                        ${problem.source ? `<span class="badge badge-source">${problem.source}</span>` : ''}
                    </div>
                    <p><strong>Author:</strong> ${problem.author}</p>
                    <p><strong>Added:</strong> ${new Date(problem.date_added).toLocaleString()}</p>
                    ${problem.description ? `<div style="margin: 20px 0;"><h4>Description:</h4><p style="line-height: 1.6;">${problem.description}</p></div>` : ''}
                    ${problem.solution ? `<div style="margin: 20px 0;"><h4>Solution Approach:</h4><p style="line-height: 1.6;">${problem.solution}</p></div>` : ''}
                    ${problem.notes ? `<div style="margin: 20px 0;"><h4>Notes:</h4><p style="line-height: 1.6;">${problem.notes}</p></div>` : ''}
                `;
                document.getElementById('problemModal').style.display = 'block';
            });
        }

        // Close modal
        function closeModal() {
            document.getElementById('problemModal').style.display = 'none';
        }

        // Delete problem with confirmation
        async function confirmDeleteProblem(id) {
            if (confirm('Are you sure you want to delete this problem? This action cannot be undone.')) {
                try {
                    await deleteProblem(id);
                    displayMyProblems();
                    displayCommunity(); // Refresh community stats
                } catch (error) {
                    alert('Error deleting problem: ' + error.message);
                }
            }
        }

        // Search functionality
        async function populateUserFilters() {
            try {
                const users = await getUsers();
                const searchUserFilter = document.getElementById('searchUserFilter');
                const statsUserFilter = document.getElementById('statsUserFilter');

                const userOptions = users.map(user =>
                    `<option value="${user.username}">${user.username}</option>`
                ).join('');

                if (searchUserFilter) {
                    searchUserFilter.innerHTML = `
                        <option value="all">All Users</option>
                        <option value="mine">My Problems Only</option>
                        ${userOptions}
                    `;
                }

                if (statsUserFilter) {
                    statsUserFilter.innerHTML = `
                        <option value="all">All Users Combined</option>
                        <option value="mine">My Statistics</option>
                        ${userOptions}
                    `;
                }
            } catch (error) {
                console.error('Error populating user filters:', error);
            }
        }

        async function searchProblems() {
            const query = document.getElementById('searchQuery').value.toLowerCase().trim();
            const userFilter = document.getElementById('searchUserFilter').value;
            const searchFilter = document.getElementById('searchFilter').value;
            const resultsContainer = document.getElementById('searchResults');
            const loadingDiv = document.getElementById('searchLoading');

            if (!query) {
                resultsContainer.innerHTML = '<p>Please enter a search term.</p>';
                return;
            }

            showLoading('searchLoading');
            resultsContainer.innerHTML = '';

            try {
                const filters = {};

                // Apply user filter
                if (userFilter === 'mine') {
                    filters.author = currentUser;
                } else if (userFilter !== 'all') {
                    filters.author = userFilter;
                }

                // Apply search filter
                if (searchFilter === 'all') {
                    filters.search = query;
                } else {
                    // For specific field searches, we'll get all problems and filter client-side
                    // This is because Supabase's text search is limited
                    const allProblems = await getProblems(filters);
                    const results = allProblems.filter(problem => {
                        const fieldValue = problem[searchFilter];
                        return fieldValue && fieldValue.toLowerCase().includes(query);
                    });

                    displaySearchResults(results);
                    return;
                }

                const results = await getProblems(filters);
                displaySearchResults(results);
            } catch (error) {
                resultsContainer.innerHTML = '<p>Error searching problems. Please try again.</p>';
            } finally {
                hideLoading('searchLoading');
            }
        }

        function displaySearchResults(results) {
            const container = document.getElementById('searchResults');

            if (results.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No results found</h3>
                        <p>Try different keywords or search filters.</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <h3>Search Results (${results.length} found)</h3>
                    ${results.map(problem => createProblemCard(problem, false)).join('')}
                `;
            }
        }

        // Statistics functionality
        async function displayStatistics() {
            const statsFilter = document.getElementById('statsUserFilter').value;
            const statsGrid = document.getElementById('statsGrid');
            const detailedStats = document.getElementById('detailedStats');
            const loadingDiv = document.getElementById('statsLoading');

            showLoading('statsLoading');
            statsGrid.innerHTML = '';
            detailedStats.innerHTML = '';

            try {
                let statsProblems = [];

                if (statsFilter === 'mine') {
                    statsProblems = await getProblems({ author: currentUser });
                } else if (statsFilter !== 'all') {
                    statsProblems = await getProblems({ author: statsFilter });
                } else {
                    statsProblems = await getProblems();
                }

                if (statsProblems.length === 0) {
                    statsGrid.innerHTML = `
                        <div class="empty-state">
                            <h3>No statistics available</h3>
                            <p>No problems found for the selected filter.</p>
                        </div>
                    `;
                    return;
                }

                // Calculate statistics
                const totalProblems = statsProblems.length;
                const difficulties = statsProblems.reduce((acc, p) => {
                    acc[p.difficulty || 'Unknown'] = (acc[p.difficulty || 'Unknown'] || 0) + 1;
                    return acc;
                }, {});

                const topics = statsProblems.reduce((acc, p) => {
                    acc[p.topic || 'Unknown'] = (acc[p.topic || 'Unknown'] || 0) + 1;
                    return acc;
                }, {});

                const sources = statsProblems.reduce((acc, p) => {
                    acc[p.source || 'Unknown'] = (acc[p.source || 'Unknown'] || 0) + 1;
                    return acc;
                }, {});

                const authors = statsProblems.reduce((acc, p) => {
                    acc[p.author] = (acc[p.author] || 0) + 1;
                    return acc;
                }, {});

                // Display main stats
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${totalProblems}</div>
                        <div class="stat-label">Total Problems</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${Object.keys(topics).length}</div>
                        <div class="stat-label">Different Topics</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${Object.keys(sources).length}</div>
                        <div class="stat-label">Different Sources</div>
                    </div>
                    ${statsFilter === 'all' ? `
                    <div class="stat-card">
                        <div class="stat-number">${Object.keys(authors).length}</div>
                        <div class="stat-label">Active Contributors</div>
                    </div>
                    ` : ''}
                `;

                // Display detailed breakdown
                let detailedHtml = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div class="problem-card">
                            <h3>By Difficulty</h3>
                            ${Object.entries(difficulties).map(([diff, count]) =>
                    `<p><strong>${diff}:</strong> ${count} problems</p>`
                ).join('')}
                        </div>
                        <div class="problem-card">
                            <h3>By Topic</h3>
                            ${Object.entries(topics).slice(0, 10).map(([topic, count]) =>
                    `<p><strong>${topic}:</strong> ${count} problems</p>`
                ).join('')}
                            ${Object.keys(topics).length > 10 ? '<p><em>...and more</em></p>' : ''}
                        </div>
                        <div class="problem-card">
                            <h3>By Source</h3>
                            ${Object.entries(sources).slice(0, 10).map(([source, count]) =>
                    `<p><strong>${source}:</strong> ${count} problems</p>`
                ).join('')}
                            ${Object.keys(sources).length > 10 ? '<p><em>...and more</em></p>' : ''}
                        </div>
                `;

                if (statsFilter === 'all') {
                    detailedHtml += `
                        <div class="problem-card">
                            <h3>Top Contributors</h3>
                            ${Object.entries(authors)
                            .sort(([, a], [, b]) => b - a)
                            .slice(0, 10)
                            .map(([author, count]) =>
                                `<p><strong>${author}:</strong> ${count} problems</p>`
                            ).join('')}
                        </div>
                    `;
                }

                detailedHtml += '</div>';
                detailedStats.innerHTML = detailedHtml;
            } catch (error) {
                statsGrid.innerHTML = `
                    <div class="empty-state">
                        <h3>Error loading statistics</h3>
                        <p>Please try again later.</p>
                    </div>
                `;
            } finally {
                hideLoading('statsLoading');
            }
        }

        // Event listeners
        document.getElementById('searchQuery').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                searchProblems();
            }
        });

        // Close modal when clicking outside
        window.onclick = function (event) {
            const modal = document.getElementById('problemModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Initialize app after DOM is loaded
        window.addEventListener('load', function () {
            // Check if Supabase credentials are configured
            if (SUPABASE_URL.includes('your-project-id') || SUPABASE_ANON_KEY.includes('your-anon')) {
                document.body.innerHTML = `
                    <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
                        <h2>‚ö†Ô∏è Supabase Configuration Required</h2>
                        <p>Please update the Supabase URL and API key in the JavaScript code:</p>
                        <ol style="text-align: left; max-width: 600px; margin: 20px auto;">
                            <li>Create a new project at <a href="https://supabase.com" target="_blank">supabase.com</a></li>
                            <li>Copy your project URL and anon public key</li>
                            <li>Replace SUPABASE_URL and SUPABASE_ANON_KEY in the code</li>
                            <li>Run the database setup SQL commands in your Supabase SQL editor</li>
                        </ol>
                        <div style="margin-top: 30px; padding: 20px; background: #f0f0f0; border-radius: 8px; text-align: left;">
                            <h4>Database Setup SQL:</h4>
                            <pre style="background: #333; color: #fff; padding: 15px; border-radius: 4px; overflow-x: auto;">
-- Create users table
CREATE TABLE users (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    username TEXT UNIQUE NOT NULL,
    email TEXT,
    join_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create problems table  
CREATE TABLE problems (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    title TEXT NOT NULL,
    source TEXT,
    difficulty TEXT,
    topic TEXT,
    description TEXT,
    solution TEXT,
    notes TEXT,
    author TEXT NOT NULL,
    date_added TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    FOREIGN KEY (author) REFERENCES users (username)
);

-- Enable RLS (Row Level Security)
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE problems ENABLE ROW LEVEL SECURITY;

-- Create policies
CREATE POLICY "Users can view all users" ON users FOR SELECT USING (true);
CREATE POLICY "Users can insert their own data" ON users FOR INSERT WITH CHECK (auth.uid() = id);

CREATE POLICY "Anyone can view problems" ON problems FOR SELECT USING (true);
CREATE POLICY "Users can insert their own problems" ON problems FOR INSERT WITH CHECK (auth.jwt() ->> 'username' = author OR auth.jwt() ->> 'email' = author);
CREATE POLICY "Users can update their own problems" ON problems FOR UPDATE USING (auth.jwt() ->> 'username' = author OR auth.jwt() ->> 'email' = author);
CREATE POLICY "Users can delete their own problems" ON problems FOR DELETE USING (auth.jwt() ->> 'username' = author OR auth.jwt() ->> 'email' = author);
                            </pre>
                        </div>
                    </div>
                `;
                return;
            }

            populateUserFilters();
        });
    </script>
</body>


</html>
